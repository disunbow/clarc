<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>CLARC: sync local files to Amazon S3 cloud storage</title>
	<link href="style.css" rel="stylesheet" media="all">
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.0.6/modernizr.min.js"></script>
</head>
<body>
<a href="https://github.com/egorFiNE/clarc"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a>

<div id="page" class="hentry">
	<header class="the-header">
		<div class="unit-head">
			<div class="unit-inner unit-head-inner">
				<nav class="nav-global">
					<ul>
						<li class="logo"><a href="/clarc">CLARC: sync local files to Amazon S3 cloud storage</a></li>
						<li><a href="#quickstart">quickstart</a></li>
						<li><a href="#manual">manual</a></li>
						<li><a href="#downloads">downloads</a></li>
						<li><a href="#faq">faq</a></li>
						<li><a href="#todo">todo</a></li>
						<li><a href="build.html">build</a></li>
					</ul>
				</nav>
			</div><!-- unit-inner -->
		</div><!-- unit-head -->
	</header>
	<div class="body" role="main">
		<div class="unit-body">
			<div class="unit-inner unit-body-inner">
				<div class="entry-content">
					
<article class="unit-article layout-page">
	<div class="unit-inner unit-article-inner">
		<div class="content">

			<div class="bd">
				<div class="entry-content">

<div>
	<div class="features">
		<ul class="features">
			<li>Great for backup and S3&#160;website deployment</li>
			<li>Multithreaded</li>
			<li>Linux and OS&nbsp;X support</li>
		</ul>
	</div>

	<div style="float: left; width: 70%; min-width: 300px; max-width: 600px;"> 
		<p>
			<b>clarc</b> is a free *nix commandline utility that synchronizes local file system folder to <a href="http://aws.amazon.com/s3/">Amazon S3</a>. Only files that were changed/added since last <b>clarc</b> invocation are uploaded.
		</p>


		<p>
			<b>clarc</b> keeps track of changes by storing file metadata in a small local database. 
			It possible to quickly rebuild the database from Amazon S3.
		</p>
	</div>
	<div style="clear: both"></div>
</div>

<h2 id="quickstart">
	Quick start
	<div style="float: right; width: 200px;"><a class="download" href="#downloads">Downloads &darr;</a></div>
</h2>

<pre><code>clarc <span class="codeBackslash">\</span>
      --accessKeyId UKIOIZZADUGFFDD7SFVF  <span class="codeBackslash">\</span>
      --secretAccessKey sDFGsvSVsd5S47hbBFfGfa634CbAs0Q4V547bGGa  <span class="codeBackslash">\</span>
      <span class="paramSource">/home/egor/Music/</span>  <span class="paramDest">s3://music.egorfine.com/</span></code></pre>

<p>
	This will upload all local files from <span class="paramSource">/home/egor/Music</span> to Amazon S3 bucket <span class="paramDest">music.egorfine.com</span>. <b>clarc</b> will create a database file <span style="white-space: nowrap"><span class="paramSource">/home/egor/Music</span>/.files.sqlite3</span>. 
</p>

<p>Subsequent invocations of the same command line will scan <span class="paramSource">/home/egor/Music</span> and compare the file system metadata with the one stored in database. Only changes will be uploaded to S3.
</p>

<h2 id="downloads">Downloads</h2>

<p>
	<a href="https://github.com/egorFiNE/clarc">Source code</a> is available at Github. 
</p>

<p>
	I'd suggest you don't bother with all Linux/OS X depencies and use the <a href="https://github.com/egorFiNE/clarc/downloads">binaries I provide</a>. Don't forget to <code>chmod +x</code> them.
</p>

<h2 id="manual">Manual</h2>

<h3>Local meta database</h3>

<p>
	<b>clarc</b> uses local sqlite database to store files metadata. On subsequent invocations with the same path <b>clarc</b> will compare actual filesystem state with the database previously stored and only upload changed files. Database is stored in the same source folder in file named <code>.files.sqlite3</code>.
</p>


<p>However this database is by no mean vital. It can be quickly rebuilt from scratch with <code>--rebuild</code> command, like this:</p>

<pre><code>clarc --rebuild <span class="codeBackslash">\</span>
      --accessKeyId UKIOIZZADUGFFDD7SFVF  <span class="codeBackslash">\</span>
      --secretAccessKey sDFGsvSVsd5S47hbBFfGfa634CbAs0Q4V547bGGa  <span class="codeBackslash">\</span>
      <span class="paramSource">/home/egor/Music/</span>  <span class="paramDest">s3://music.egorfine.com</span></code></pre>

<h3>Retransmit algorythm and consistency issues</h3>

<p>
	<b>clarc</b> does it's best to upload the file even in case the upload fails. In case of recoverable HTTP/Network error <b>clarc</b> will retry up to <b>3</b> to retransmit a file increasingly sleeping between tries. <b>clarc</b> gives up only in case all three attempts fail. The connect timeout is <b>15 seconds</b>, transmission timeout is <b>10 seconds</b>.
</p>

<p>
	The file is updated in local meta database <b>only</b> after it is successfully uploaded and Amazon S3 returned MD5 checksum (which is also stored, of course).
</p>

<h3>S3 destination</h3>

<p>S3 destination is specified in the form <code>s3://BUCKET<span class="paramDest">[.ENDPOINT]</span>/</code> where <span class="paramDest">ENDPOINT</span> is optional and could be one of those: 

	<ul style="padding-left: 2em">
<li>s3.amazonaws.com (<i>the default</i>);</li>
<li>s3-us-west-2.amazonaws.com;</li>
<li>s3-us-west-1.amazonaws.com;</li>
<li>s3-eu-west-1.amazonaws.com;</li>
<li>s3-ap-southeast-1.amazonaws.com;</li>
<li>s3-ap-northeast-1.amazonaws.com;</li>
<li>s3-sa-east-1.amazonaws.com;</li>
	</ul>

<h3>Path options</h3>

<dl>
	<dt>--exclude <span class="argument">&lt;pattern&gt;</span></dt>
	<dd>Ignore certain files/folders according to the Regular Expression pattern. Example:

<pre>clarc <span class="codeBackslash">\</span>
      --accessKeyId UKIOIZZADUGFFDD7SFVF  <span class="codeBackslash">\</span>
      --secretAccessKey sDFGsvSVsd5S47hbBFfGfa634CbAs0Q4V547bGGa  <span class="codeBackslash">\</span>
      --exclude <span class="paramExclude">.+\.m4a$</span> --exclude <span class="paramExclude">.+\.m4v$</span> <span class="codeBackslash">\</span>
      --exclude <span class="paramExclude">\/Justin\ Bieber\/.+$</span> <span class="codeBackslash">\</span>
      <span class="paramSource">/home/egor/Music/</span>  <span class="paramDest">s3://music.egorfine.com/</span></pre>

      This will upload everything but m4v &amp; m4a files as well as skip a folder with garbage. You can specify more than a single <code>--exclude</code> parameter. <br/><br/>
      See <a href="http://code.google.com/p/re2/wiki/Syntax">Google re2 syntax</a> page for details on the possible regular expressions.
	</dd>

	<dt>--excludeFromFile <span class="argument">&lt;file name&gt;</span></dt>
	<dd>The same as <code>--exclude</code> but will read a list of exclude patterns from file instead of the command-line argument. The patterns in file must be newline-separated.</dd>
</dl>

<h3>Amazon S3 options</h3>

<dl>
	<dt>--rebuild</dt>
	<dd>Prior to uploading download files list and meta information from Amazon S3 and rebuild local database from scratch.</dd>

	<dt>--accessKeyId <span class="argument">&lt;string&gt;</span>, --secretAccessKey <span class="argument">&lt;string&gt;</span> <span class="mandatory">*</span></dt>
	<dd>Amazon S3 Access Credentials. Get them <a href="https://portal.aws.amazon.com/gp/aws/securityCredentials">here</a>. You can also specify them in environment variables <code>S3_ACCESSKEYID</code> and <code>S3_SECRETACCESSKEY</code> instead of the command line.

	<dt>--rrs</dt>
	<dd>Use <a href="http://aws.amazon.com/s3/faqs/#What_is_RRS">Reduced Redundancy Storage</a> instead of the Standard Storage.</dd>

	<dt>--public</dt>
	<dd>Make all uploaded files publicly accessible on Amazon S3. By default all files are private.</dd>

	<dt>--create <span class="argument">&lt;region&gt;</span></dt>
	<dd>Create S3 bucket if it doesn't exists. Region must be one of:  <code>US</code> (default), <code>EU</code>, <code>eu-west-1</code>, <code>us-west-1</code>, <code>us-west-2</code>, <code>ap-southeast-1</code>, <code>ap-northeast-1</code>, <code>sa-east-1</code>. Bucket is always created with private ACL.</dd>

	<dt>--skipSsl</dt>
	<dd>Do not use SSL when connecting to S3. It is significantly faster for <code>--rebuild</code> and quite useful if you are connecting within AWS.</dd> 
</dl>

<h3>Display options</h3>

<dl>
	<dt>--progress</dt>
	<dd>Show progress indicator for meta update and uploads.</dd>

	<dt>--logLevel <span class="argument">&lt;int&gt;</span></dt>
	<dd>Set stdout log level. 

		Possible values are: 
		<ol style="padding-left: 2em">
			<li>only fatals;</li>
			<li>+errors;</li>
			<li>+warnings;</li>
			<li>+info;</li>
			<li>debug.</li>
		</ol>

	Default is 2 (fatals and errors). 
	</dd>
</dl>

<h3>Metadata storage options</h3>

<dl>
	<dt>--dbPath <span class="argument">&lt;path&gt;</span></dt>
	<dd>Absolute path to local database file instead of the default path. 
		By default it's the source folder. <b>Note:</b> this argument MUST NOT specify file name.</dd>

	<dt>--dbFilename <span class="argument">&lt;file name&gt;</span></dt>
	<dd>File name for the database. By default it's <code>.files.sqlite3</code>.
</dl>

<h3>Network options</h3>

<dl>
	<dt>--uploadThreads <span class="argument">&lt;int&gt;</span></dt>
	<dd>Count of threads to spawn for upload. Default: 4.</dd>
	<dt>--connectTimeout <span class="argument">&lt;seconds&gt;</span></dt>
	<dd>Timeout for connect operation only, in seconds. Default: 15.</dd>
	<dt>--networkTimeout <span class="argument">&lt;seconds&gt;</span></dt>
	<dd>How many seconds to wait till the stalled connection should be killed. Default: 15.</dd>
</dl>

<h3>Misc options</h3>

<dl>
	<dt>--rebuildOnly</dt>
	<dd>Do not actually upload files, only run <code>--rebuild</code>.</dd>
	<dt>--dryRun</dt>
	<dd>Do not actually upload files; do not actually rebuild database.</dd>
	<dt>--version, --help</dt>
	<dd>Says something.</dd>
</dl>

<p>
<span class="mandatory">*</span> means the option is mandatory.
</p>

<h2 id="faq">FAQ</h2>

<dl>
	<dt>Access Key ID? Secret access key? What are those?</dt>
	<dd>It's the way Amazon S3 authenticates it's users. Go <a href="https://portal.aws.amazon.com/gp/aws/securityCredentials">Security Credentials</a> page, scroll down to Access Credentials and find your keys here: <br/><br/>
		<img src="amazonCredentials.png" alt="Amazon Credentials page" style="margin-left: 0; margin-bottom: 0"/><br/>
		Oh yes and you have to have an account with Amazon AWS, did I forgot to tell?
	</dd>

	<dt>Okay, I understand this tool uploads files, but what about downloads?</dt>
	<dd>
		Downloads are yet to be implemented but please note: a) <b>clarc</b> stores files on Amazon S3 as-is. 
		You can download them with any currently available downloader. b) <b>clarc</b> stores all file metadata, 
		so in the future it will be able to download files and restore their state (uid, gid, permissions, etc).
	</dd>

	<dt>How secure are my files?</dt>
	<dd>As secure as Amazon S3 storage is. Client-side encryption is planned. Files are transferred over SSL-encrypted socket unless <code>--skipSsl</code> is specified.</dd>

	<dt>Do you support Amazon S3 Server Side Encryption?</dt>
	<dd>
		No and it isn't planned. Server Side Encryption only protects your files from inner Amazon S3 hacks 
		or rogue employees. It doesn't protect you from data theft. Client side encryption will solve both when implemented.
	</dd>

	<dt>What if I loose the database file?</dt>
	<dd>No worries: use <code>--rebuild</code> command to recover.</dd>

	<dt>Which files are not uploaded?</dt>
	<dd>
		<ul style="margin-bottom: 0">
			<li>Files over 5Gb (due to Amazon limitations);</li>
			<li>Symlinks (although feature planned);</li>
			<li>Device files;</li>
			<li>Empty directories;</li>
		</ul>
	</dd>

	<dt>I have downloaded the binary file and it says Permission denied.</dt>
	<dd><code>chmod +x</code> it.</dd>

	<dt>I am uploading to european S3 bucket in Ireland and keep getting "Connection reset by peer".</dt>
	<dd>Nothing we can do at this point: <a href="http://www.google.com/search?q=amazon+s3+connection+reset+by+peer">it's a known bug</a>. Try <a href="http://scie.nti.st/2008/3/14/amazon-s3-and-connection-reset-by-peer">this</a>.</dd>

	<dt>I have downloaded the binary but nothing happens when I click on it</dt>
	<dd>It's a <i>command-line</i> application. You won't be able to use it.</dd>

	<dt>C++ sucks!</dt>
	<dd>In fact the tool is written in C. I only use C++ <code>class</code> as a syntax sugar. Yes it could all be done in plain C but this would be ugly.</dd>

	<dt>What about Windows?</dt>
	<dd>What about Windows?</dd>

	<dt>What license is clarc available under?</dt>
	<dd>MIT. See <code>LICENSE</code> in source code.</dd>

	<dt>What does "clarc" stands for?</dt>
	<dd><b>CL</b>oud <b>ARC</b>hiver. Or <b>C</b>ommand-<b>L</b>ine <b>ARC</b>hiver. Or both.</dd>

<!--
	<dt>qestion</dt>
	<dd>ansah</dd>
-->
</dl>


<h2 id="todo">TODO</h2>

<h3>Client-side encryption</h3> 

<p>
	As much as I trust Amazon I don't trust myself securely storing keys and someone else stealing my data. Therefore <b>clarc</b>  must 
	(optionally of course) encrypt files before they are uploaded to Amazon S3.
</p>

<h3>Delete obsoleted files from S3</h3> 

<p>
	This feature is dangerous and absolutely not as simple as it looks. Before I begin implementing it I have to 
	make sure the core of the application works good enough so that it properly generates and propagates error codes
	thru the code. 
</p>

<p>
	When the upload finishes with no errors and all files were uploaded correctly I can rescan the file system and
	issue multiple DELETE command on the S3 bucket to delete files that don't exists anymore locally. This will only 
	be done if additional option is specified on the commandline (<code>--delete</code>).
</p>

<h3>Script (config files)</h3> 

<p>
	Essentially this is just command line parsing from file instead of the command line. So instead of calling <code>clarc ...</code> you will invoce <code>clarc ./backup.ini</code> or something.
</p>

<h3>Check UID, GID and mode changes</h3>

<p>
	Right now file and metadata is not updated on Amazon S3 if this is the only thing that changed. 
</p>

<h3>Restore</h3>

<p>
	Only one direction is implemented now: uploads from local folder to S3. Surely the other way is also required: download of the remote files into local folder. While it is possible to use other tools to download files (plenty are available), none of them recovers the metadata (UID, GID, permissions, etc). <b>clarc</b> should be able to restore folder as it was. 
</p>

<p>
	<b>NOTE: clarc DOES store metadata information with Amazon, so you can safely use it for backups right now.</b> Once the download feature will be implemented, clarc will be able to download and restore already made backups.
</p>

<h3>Other pending enhancements</h3>

<a href="https://github.com/egorFiNE/clarc/issues?labels=enhancement&page=1&state=open">I am tracking them at Github.</a>



				</div><!-- entry-content -->
			</div><!-- bd -->

		</div><!-- content -->
	</div><!-- unit-inner -->
</article>


				</div>
			</div><!-- unit-inner -->
		</div><!-- unit-body -->
	</div><!-- body -->
	<footer class="the-footer">
		<div class="unit-foot">
			<div class="unit-inner unit-foot-inner">
				<div class="misc vcard">
					<h4>About</h4>
					<ul>
						<li><address><span class="author fn n">Egor Egorov</span> &mdash; <span class="fn email">me@egorfine.com</span></address></li>
						<li>Report bugs on <a href="https://github.com/egorFiNE/clarc/issues" rel="me">Github issues tracker</a></li>
					</ul>
				</div><!-- misc -->
				<p class="licence">
					Theme: <b>the_minimum</b> based on <a href="http://jekyllbootstrap.com/">Jekyll-bootstrap</a>.
				</p>
			</div><!-- unit-foot-inner -->
		</div><!-- unit-foot -->
	</footer>
</div><!-- page -->

</body>
</html>
